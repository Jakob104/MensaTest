<!DOCTYPE html>
<html lang="de">
<%- include('partials/head') %>
<body>
    <%- include('partials/navbar') %>

    <div class="container">
        <h1 style="color: #ff6600; margin-bottom: 10px;">Wochenplan bearbeiten üìù</h1>
        <p style="margin-bottom: 30px; color: #666;">Suche nach einem Gericht, um es dem Tag zuzuweisen.</p>

        <div style="display: grid; gap: 20px;">
            
            <% const days = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag"]; %>
            <% const menus = ["Men√º 1", "Men√º 2"]; %>

            <% days.forEach(day => { %>
                <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <h2 style="margin-top:0; border-bottom: 2px solid #ff6600; display:inline-block; padding-bottom: 5px;"><%= day %></h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                        <% menus.forEach(menuType => { %>
                            
                            <% const entry = plan.find(p => p.day === day && p.menuType === menuType); %>
                            
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                                <strong style="color: #333;"><%= menuType %>:</strong>
                                
                                <div id="display-<%= day %>-<%= menuType.replace(' ', '') %>" 
                                     style="margin: 10px 0; font-weight: bold; color: #ff6600; font-size: 1.1rem; min-height: 25px;">
                                    <%= entry ? entry.dish.name : "‚Äî Nichts ausgew√§hlt ‚Äî" %>
                                </div>

                                <div style="position: relative;">
                                    <input type="text" 
                                           placeholder="Gericht suchen (z.B. Schnitzel)..." 
                                           class="search-input"
                                           onkeyup="searchDish(this, '<%= day %>', '<%= menuType %>')"
                                           style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.9rem;">
                                    
                                    <div class="suggestions" id="suggest-<%= day %>-<%= menuType.replace(' ', '') %>" 
                                         style="position: absolute; background: white; border: 1px solid #ddd; width: 100%; z-index: 100; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                    </div>
                                </div>

                            </div>
                        <% }); %>
                    </div>
                </div>
            <% }); %>

        </div>
        
        <div style="height: 50px;"></div> </div>

    <script>
        // 1. Suche nach Gerichten (Dishes)
        async function searchDish(input, day, menuType) {
            const query = input.value;
            // ID generieren, um die richtige Box zu finden
            const suggestBoxId = `suggest-${day}-${menuType.replace(' ', '')}`;
            const suggestBox = document.getElementById(suggestBoxId);

            if (query.length < 2) {
                suggestBox.style.display = 'none';
                return;
            }

            try {
                // API aufrufen (sucht in der Dish Tabelle)
                const res = await fetch(`/api/dishes/search?q=${query}`);
                const dishes = await res.json();

                // Vorschl√§ge rendern
                suggestBox.innerHTML = '';
                if (dishes.length > 0) {
                    suggestBox.style.display = 'block';
                    dishes.forEach(dish => {
                        const div = document.createElement('div');
                        div.style.padding = '10px';
                        div.style.cursor = 'pointer';
                        div.style.borderBottom = '1px solid #eee';
                        div.innerHTML = `<strong>${dish.name}</strong> <span style="color:#888; font-size:0.8em;">‚Ç¨ ${dish.price.toFixed(2)}</span>`;
                        
                        div.onmouseover = () => div.style.background = '#ffe0b2'; // Hellorange beim Dr√ºberfahren
                        div.onmouseout = () => div.style.background = 'white';
                        
                        // Wenn man draufklickt: Speichern!
                        div.onclick = () => saveEntry(day, menuType, dish.id, dish.name);
                        
                        suggestBox.appendChild(div);
                    });
                } else {
                    suggestBox.style.display = 'none';
                }
            } catch (err) {
                console.error(err);
            }
        }

        // 2. Auswahl speichern
        async function saveEntry(day, menuType, dishId, dishName) {
            try {
                const res = await fetch('/api/plan/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ day, menuType, dishId })
                });

                if (res.ok) {
                    // Anzeige sofort aktualisieren (ohne Neuladen)
                    const displayId = `display-${day}-${menuType.replace(' ', '')}`;
                    document.getElementById(displayId).innerText = dishName;
                    
                    // Suchfeld aufr√§umen
                    const suggestId = `suggest-${day}-${menuType.replace(' ', '')}`;
                    const suggestBox = document.getElementById(suggestId);
                    suggestBox.style.display = 'none';
                    suggestBox.previousElementSibling.value = ''; // Input leeren
                    
                    // Optional: Kleines Feedback
                    // alert(`‚úÖ ${day} ${menuType} aktualisiert!`);
                }
            } catch (e) {
                alert("Fehler beim Speichern der Auswahl.");
            }
        }

        // Klick au√üerhalb schlie√üt die Vorschlagslisten
        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('search-input')) {
                document.querySelectorAll('.suggestions').forEach(el => el.style.display = 'none');
            }
        });
    </script>
</body>
</html>