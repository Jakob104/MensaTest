<!DOCTYPE html>
<html lang="de">
<%- include('partials/head') %>
<body>
    <%- include('partials/navbar') %>

    <div class="container">
        <div style="margin-top: 20px;">
            <a href="/admin" style="text-decoration: none; color: #64748b;">&larr; Zur√ºck zur Zentrale</a>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-top: 20px; margin-bottom: 30px;">
            <div>
                <h1 style="margin: 0;">Bestellungen üë®‚Äçüç≥</h1>
                <p style="margin: 0; color: #64748b;">√úbersicht f√ºr die K√ºche</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="window.location.reload()" class="btn btn-outline">üîÑ Aktualisieren</button>
            </div>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>Name</th>
                        <th>Klasse</th>
                        <th>Abhol-Termin</th> 
                        <th style="width: 30%;">Bestellung</th>
                        <th>Summe</th>
                        <th>Status</th>
                        <th style="text-align: right;">Aktion</th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.forEach(function(order) { %>
                        <tr style="transition: background 0.3s; opacity: <%= order.status === 'ABGEHOLT' ? '0.5' : '1' %>; background: <%= order.status === 'ABGEHOLT' ? '#f8fafc' : 'white' %>;">
                            
                            <td style="font-family: monospace; color: #94a3b8;"><%= order.id %></td>
                            <td style="font-weight: 700; color: #0f172a;"><%= order.customerName %></td>
                            <td><span class="badge-info" style="color:#475569; background:#f1f5f9;"><%= order.userClass || '-' %></span></td>
                            <td>
                                <div style="font-weight: bold; color: #0f172a;">
                                    <% if (order.pickupDate) { %><%= new Date(order.pickupDate).toLocaleDateString('de-AT') %><% } else { %> - <% } %>
                                </div>
                                <div style="color: #2563eb; font-weight: 600; font-size: 0.9rem;">‚è∞ <%= order.pickupTime || 'Unbekannt' %> Uhr</div>
                            </td>
                            <td style="color: #475569; font-size: 0.95rem;"><%= order.items %></td>
                            <td style="font-weight: bold;">‚Ç¨ <%= order.totalPrice.toFixed(2).replace('.', ',') %></td>
                            <td style="text-align: center;">
                                <% if (order.status === 'NEU') { %>
                                    <span class="badge-open">OFFEN</span>
                                <% } else { %>
                                    <span class="badge-done">ERLEDIGT</span>
                                <% } %>
                            </td>
                            <td style="text-align: right;">
                                <% if (order.status !== 'ABGEHOLT') { %>
                                    <button onclick="markAsDone('<%= order.id %>')" class="btn" style="padding: 8px 16px; font-size: 0.85rem; background: #22c55e;">‚úî Fertig</button>
                                <% } else { %>
                                    <span style="color: #cbd5e1; font-size: 1.2rem;">‚úÖ</span>
                                <% } %>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        
        <% if (orders.length === 0) { %>
            <div style="text-align:center; padding: 60px 20px;">
                <h3 style="color: #94a3b8; margin: 0;">Alles erledigt.</h3>
            </div>
        <% } %>
    </div>

    <script>
        async function markAsDone(id) {
            try {
                const res = await fetch('/api/admin/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId: id, status: 'ABGEHOLT' })
                });

                if (res.ok) { 
                    showToast("Bestellung erledigt!", "success");
                    setTimeout(() => window.location.reload(), 500); // Kurz warten f√ºr Animation
                } 
                else { showToast("Fehler beim Speichern.", "error"); }
            } catch (err) {
                showToast("Verbindungsfehler", "error");
            }
        }
        setTimeout(() => window.location.reload(), 30000);
    </script>
    <%- include('partials/footer') %>
</body>
</html>